
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Amazon&#8217;s Relational Database Service (RDS) &#8211; The Black Box From Hell - Charles Hooper</title>
  <meta name="author" content="Charles Hooper">

  
  <meta name="description" content="One morning I woke up early and checked my email. My plan was to check that my inbox was empty for some peace of mind and then go back to bed for a &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.charleshooper.net/blog/amazons-relational-database-service-rds-the-black-box-from-hell">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/subversity" rel="alternate" title="Charles Hooper" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-12888528-1']);
    _gaq.push(['_trackPageview']);

    setTimeout("_gaq.push(['_trackEvent', '60_seconds', 'read'])", 60000);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Charles Hooper</a></h1>
  
    <h2>Thoughts and projects from a Hacker and Operations Engineer</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/subversity" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.charleshooper.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
	<li><a href="/about/">About Charles</a></li>
	<li><a href="/projects/">Projects</a></li>
	<li><a href="/contact/">Contact</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Amazon&#8217;s Relational Database Service (RDS) &#8211; the Black Box From Hell</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-10T00:00:00-07:00" pubdate data-updated="true">Aug 10<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><h1></h1>

<p>One morning I woke up early and checked my email. My plan was to check that my inbox was empty for some peace of mind and then go back to bed for a few more hours (I love Sundays). But that isn’t what happened. Instead, upon opening my inbox I was alerted that one of a client’s database servers was offline. I snapped out of my haze and immediately got to work.</p>

<p>This particular database server was a RDS instance. RDS, or <a href="http://aws.amazon.com/rds/">Relational Database Service</a>, is an Amazon-provided MySQL (or Oracle) server that runs on top of the EC2 platform. The advantages to this service are that backups are performed automatically (complete with point-in-time recovery,) snapshots are supported, the instances can be resized with more or less RAM/CPU/storage through the AWS console, and a whole bunch of other stuff (“maintenance”) is supposed to be performed for you automatically.</p>

<p>The disadvantages don’t make themselves apparent until you need to debug or troubleshoot a performance or availability issue. While CloudWatch metrics are included as part of the RDS package, knowing how much CPU, RAM, or storage space you’re using is only a very small part of knowing what your database instance is actually doing.</p>

<p>Prior to attempting recovery, the first thing I did was to check the <a href="http://aws.amazon.com/cloudwatch/">CloudWatch</a> metrics. CloudWatch seems to have trouble reporting its data when the system is under durress because there were periods where there was data and there were periods where there wasn’t. The next thing I did was check the RDS event logs. Don’t get excited, the RDS event log is not a UI wrapped around system logs, it’s just a couple of entries here and there on what Amazon RDS decides to publish. The last entry in the event log was a backup job that started several hours before and never finished. These typically only take one to two minutes to finish on this instance so I knew something was wrong.</p>

<p>I didn’t want to waste time trying to troubleshoot while the database was down so I instead moved immediately to recovery and rebooted the instance through the AWS console. It’s like <a href="http://onlinelibrary.wiley.com/doi/10.1002/bltj.20187/abstract">Charles McPhail</a> says, “<a href="http://onlinelibrary.wiley.com/doi/10.1002/bltj.20187/abstract">Respond, Restore, Resolve</a>.” After about a whole 20 to 30 minutes the database server began accepting connections again but the instance was never taken out of the “REBOOTING” state when it should have transitioned to “STARTED”. With the instance in the “REBOOTING” state, my only option now was to recover from a previous backup as the rest of the functionality is disabled unless the instance is in a “STARTED” state.</p>

<p>To make matters worse, the various components in our infrastructure were connecting to this database server and were making it impossible to find out what’s going on. The max connection limit was reached and I was no longer able to login and view the process list or analyze the status variables.</p>

<p>At this point, I decided my only course of action was to spin up a new instance from a previous backup. I made this request through the AWS console and, two to three hours later, my new instance was finally up and running. About a half an hour prior to this, the old instance was transitioned into a “FAILED” state and shut down. When your instance is in the “FAILED” state, you cannot restart it. Your only option is to restore from backup. In my case, it took several hours for AWS to declare the instance as failed and it took several hours to restore the backup. I did not know that the “FAILED” state was even a possible state and had no idea that AWS could just kill an instance like that. To top it all off, Amazon sent a very nice email to the owner of the account (my client the CEO) explaining that we’ve been using an unsupported storage engine all this time.</p>

<p>As it turns out, I missed the note in the <a href="http://docs.amazonwebservices.com/AmazonRDS/latest/UserGuide/">RDS User Guide</a> that says that MyISAM is not supported, particularly when it comes to data recovery. While I understand why RDS made this decision (MyISAM gets corrupted easily and is not easy to repair sometimes,) I felt misled and uninformed about the support of the storage engines. Yes, the note is in the RDS User Guide, however, it is not mentioned anywhere in the main page about RDS nor is it in the <a href="http://aws.amazon.com/rds/faqs/">RDS FAQs</a> (where the string “MyISAM” only appears once).</p>

<p>A few weeks have gone by and we have taken steps to avoid and reduce the damage from these types of outages in the future. However, we still occasionally receive an alert where an RDS instance stops accepting connections for one to two minutes at a time and all the event log has to say is that the instance has been “recovered.” Recovered from what exactly? What did you do to it? Why does this keep happening? How do we make it stop?</p>

<p>In summary, I’ll probably never know because on RDS you do not have access to the underlying OS. This means:</p>

<ul>
<li>You do not have access to the OS process list</li>
<li>You do not have access to things like top, htop, iostat, or dstat</li>
<li>You do not have access to the process list if the MySQL process isn’t accepting connections</li>
<li>You do not have access to any system logs</li>
</ul>


<p>If you just need a quick and dirty MySQL server and you almost never want to worry about the status of your backups, go ahead and use RDS. However, if you’re concerned about reliability (that you control,) being able to effectively troubleshoot problems, and knowing the state of your underlying OS, RDS is not right for you.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Charles Hooper</span></span>

      








  


<time datetime="2011-08-10T00:00:00-07:00" pubdate data-updated="true">Aug 10<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/system-administration/'>System Administration</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.charleshooper.net/blog/amazons-relational-database-service-rds-the-black-box-from-hell/" data-via="charleshooper" data-counturl="http://www.charleshooper.net/blog/amazons-relational-database-service-rds-the-black-box-from-hell/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/a-couple-of-python-snippets/" title="Previous Post: A Couple of Python Snippets">&laquo; A Couple of Python Snippets</a>
      
      
        <a class="basic-alignment right" href="/blog/problems-at-scale/" title="Next Post: Problems at Scale">Problems at Scale &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
	<script type="text/javascript"><!--
		google_ad_client = "pub-9122341512723010";
		/* charleshooper.net sidebar */
		google_ad_slot = "2663139048";
		google_ad_width = 250;
		google_ad_height = 250;
		//-->
	</script>
	<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script>
</section>
<section>
  <h1>About Charles</h1>
	<img src="/wp-content/uploads/me-150x150.jpg" alt="Charles Hooper"/>
	<p>Charles is a hacker with a background in systems and operations engineering. He enjoys hacking on side projects, gardening, and home brewing.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/personal-kaizen-self-improvement/">My Personal Kaizen</a>
      </li>
    
      <li class="post">
        <a href="/blog/about-this-site-technical/">About this site (technical)</a>
      </li>
    
      <li class="post">
        <a href="/blog/catching-up/">Catching up</a>
      </li>
    
      <li class="post">
        <a href="/blog/intro-to-ops-metrics-collection/">Intro to Operations: Metrics Collection</a>
      </li>
    
      <li class="post">
        <a href="/blog/intro-to-ops-availability-monitoring-alerting/">Intro to Operations: Availability Monitoring and Alerting</a>
      </li>
    
  </ul>
</section>

<section>
	<script type="text/javascript"><!--
		google_ad_client = "pub-9122341512723010";
		/* charleshooper.net sidebar */
		google_ad_slot = "2663139048";
		google_ad_width = 250;
		google_ad_height = 250;
		//-->
	</script>
	<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Charles Hooper -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'charleshooper';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.charleshooper.net/blog/amazons-relational-database-service-rds-the-black-box-from-hell/';
        var disqus_url = 'http://www.charleshooper.net/blog/amazons-relational-database-service-rds-the-black-box-from-hell/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
